<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WARP Proxies</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1d27;--border:#2a2d3a;--text:#e4e4e7;--text2:#9ca3af;--accent:#f97316;--accent2:#fb923c;--green:#22c55e;--red:#ef4444;--blue:#3b82f6;--radius:8px}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.container{max-width:960px;margin:0 auto;padding:16px}
header{display:flex;align-items:center;justify-content:space-between;padding:16px 0;border-bottom:1px solid var(--border);margin-bottom:24px}
header h1{font-size:20px;font-weight:600}
header h1 span{color:var(--accent)}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:20px;font-size:12px;font-weight:500}
.badge-green{background:#22c55e20;color:var(--green)}
.badge-red{background:#ef444420;color:var(--red)}
.badge::before{content:'';width:6px;height:6px;border-radius:50%;background:currentColor}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px}
.card h2{font-size:14px;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
.stat{text-align:center;padding:12px}
.stat .value{font-size:24px;font-weight:700;color:var(--accent)}
.stat .label{font-size:12px;color:var(--text2);margin-top:4px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
button{padding:8px 16px;border-radius:var(--radius);border:1px solid var(--border);background:var(--surface);color:var(--text);font-size:13px;cursor:pointer;transition:all .15s}
button:hover{border-color:var(--accent);color:var(--accent)}
button:disabled{opacity:.5;cursor:not-allowed}
button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
button.primary:hover{background:var(--accent2)}
button.danger{border-color:var(--red);color:var(--red)}
button.danger:hover{background:var(--red);color:#fff}
.mode-toggle{display:flex;border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.mode-toggle button{border:none;border-radius:0;flex:1}
.mode-toggle button.active{background:var(--accent);color:#fff}
table{width:100%;border-collapse:collapse;font-size:13px}
th{text-align:left;padding:8px 12px;color:var(--text2);font-weight:500;font-size:12px;text-transform:uppercase;letter-spacing:.5px;border-bottom:1px solid var(--border)}
td{padding:8px 12px;border-bottom:1px solid var(--border)}
tr:last-child td{border-bottom:none}
.enabled{color:var(--green)}
.disabled{color:var(--red)}
.actions{display:flex;gap:4px}
.actions button{padding:4px 8px;font-size:11px}
input,select{padding:8px 12px;border-radius:var(--radius);border:1px solid var(--border);background:var(--bg);color:var(--text);font-size:13px;outline:none}
input:focus,select:focus{border-color:var(--accent)}
.form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px;flex-wrap:wrap}
.form-row label{font-size:12px;color:var(--text2);min-width:80px}
.form-row input{flex:1;min-width:120px}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;width:90%;max-width:400px}
.modal h3{margin-bottom:16px;font-size:16px}
.modal .form-row{margin-bottom:12px}
.modal .btn-row{display:flex;gap:8px;justify-content:flex-end;margin-top:16px}
.toast{position:fixed;bottom:20px;right:20px;padding:12px 20px;border-radius:var(--radius);font-size:13px;z-index:200;animation:slideIn .3s}
.toast-success{background:var(--green);color:#fff}
.toast-error{background:var(--red);color:#fff}
@keyframes slideIn{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.setting-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px}
.setting-grid label{font-size:12px;color:var(--text2);align-self:center}
.setting-grid input,.setting-grid select{width:100%}
@media(max-width:600px){.stats{grid-template-columns:1fr 1fr}.setting-grid{grid-template-columns:1fr}}
.endpoint-edit{display:flex;gap:4px;align-items:center}
.endpoint-edit input{width:140px;padding:3px 6px;font-size:12px}
.endpoint-edit .port{width:60px}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1><span>WARP</span> Proxies</h1>
    <div id="statusBadge" class="badge badge-red">Stopped</div>
  </header>

  <div class="card">
    <h2>Status</h2>
    <div class="stats">
      <div class="stat"><div class="value" id="accountCount">0</div><div class="label">Accounts</div></div>
      <div class="stat"><div class="value" id="currentMode">-</div><div class="label">Mode</div></div>
      <div class="stat"><div class="value" id="currentOutbound">-</div><div class="label">Current</div></div>
    </div>
  </div>

  <div class="card">
    <h2>Controls</h2>
    <div class="controls">
      <div class="mode-toggle">
        <button id="btnUrltest" onclick="switchMode('urltest')">URLTest</button>
        <button id="btnRandom" onclick="switchMode('random')">Random</button>
      </div>
      <button class="primary" onclick="showAddModal()">+ Add Account</button>
      <button onclick="showBatchModal()">+ Batch Add</button>
      <button onclick="restartEngine()">Restart Engine</button>
      <button onclick="showSettingsModal()">Settings</button>
    </div>
  </div>

  <div class="card">
    <h2>Accounts</h2>
    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr><th>Name</th><th>Endpoint</th><th>IPv4</th><th>Status</th><th>Actions</th></tr>
        </thead>
        <tbody id="accountsTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal-overlay" id="addModal">
  <div class="modal">
    <h3>Register WARP Account</h3>
    <div class="form-row"><label>Name</label><input id="addName" placeholder="auto"></div>
    <div class="form-row"><label>Endpoint</label><input id="addEndpoint" placeholder="engage.cloudflareclient.com"></div>
    <div class="form-row"><label>Port</label><input id="addPort" type="number" value="2408"></div>
    <div class="btn-row">
      <button onclick="closeModals()">Cancel</button>
      <button class="primary" onclick="createAccount()">Register</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="batchModal">
  <div class="modal">
    <h3>Batch Register</h3>
    <div class="form-row"><label>Count</label><input id="batchCount" type="number" value="3" min="1" max="20"></div>
    <div class="form-row"><label>Endpoint</label><input id="batchEndpoint" placeholder="engage.cloudflareclient.com"></div>
    <div class="form-row"><label>Port</label><input id="batchPort" type="number" value="2408"></div>
    <div class="btn-row">
      <button onclick="closeModals()">Cancel</button>
      <button class="primary" onclick="batchCreate()">Register</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h3>Settings</h3>
    <div class="setting-grid">
      <label>URLTest URL</label><input id="setUrl">
      <label>URLTest Interval (s)</label><input id="setInterval" type="number">
      <label>URLTest Tolerance (ms)</label><input id="setTolerance" type="number">
      <label>Random Interval (s)</label><input id="setRandomInterval" type="number">
      <label>Clash API Port</label><input id="setClashPort" type="number">
      <label>Clash API Secret</label><input id="setClashSecret">
    </div>
    <div class="btn-row">
      <button onclick="closeModals()">Cancel</button>
      <button class="primary" onclick="saveSettings()">Save</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="editEndpointModal">
  <div class="modal">
    <h3>Edit Endpoint</h3>
    <input type="hidden" id="editId">
    <div class="form-row"><label>Endpoint</label><input id="editEndpoint"></div>
    <div class="form-row"><label>Port</label><input id="editPort" type="number"></div>
    <div class="btn-row">
      <button onclick="closeModals()">Cancel</button>
      <button class="primary" onclick="saveEndpoint()">Save</button>
    </div>
  </div>
</div>

<script>
const API = '';

async function api(path, opts = {}) {
  const res = await fetch(API + path, {
    ...opts,
    headers: { 'Content-Type': 'application/json', ...opts.headers },
  });
  if (!res.ok && res.status !== 201) {
    const err = await res.json().catch(() => ({ error: res.statusText }));
    throw new Error(err.error || res.statusText);
  }
  return res.json();
}

function toast(msg, type = 'success') {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

function closeModals() {
  document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('show'));
}

async function refresh() {
  try {
    const [status, accounts] = await Promise.all([
      api('/api/status'),
      api('/api/accounts'),
    ]);

    const badge = document.getElementById('statusBadge');
    if (status.running) {
      badge.className = 'badge badge-green';
      badge.textContent = 'Running';
    } else {
      badge.className = 'badge badge-red';
      badge.textContent = 'Stopped';
    }

    document.getElementById('accountCount').textContent = status.account_count;
    document.getElementById('currentMode').textContent = status.mode;
    document.getElementById('currentOutbound').textContent = status.current || '-';

    document.getElementById('btnUrltest').classList.toggle('active', status.mode === 'urltest');
    document.getElementById('btnRandom').classList.toggle('active', status.mode === 'random');

    const tbody = document.getElementById('accountsTable');
    tbody.innerHTML = accounts.map(a => `
      <tr>
        <td>${esc(a.name)}</td>
        <td>${esc(a.endpoint)}:${a.endpoint_port}</td>
        <td>${esc(a.ipv4)}</td>
        <td class="${a.enabled ? 'enabled' : 'disabled'}">${a.enabled ? 'Enabled' : 'Disabled'}</td>
        <td class="actions">
          <button onclick="toggleAccount('${a.id}', ${!a.enabled})">${a.enabled ? 'Disable' : 'Enable'}</button>
          <button onclick="editEndpoint('${a.id}','${esc(a.endpoint)}',${a.endpoint_port})">Endpoint</button>
          <button class="danger" onclick="deleteAccount('${a.id}','${esc(a.name)}')">Delete</button>
        </td>
      </tr>
    `).join('');
  } catch (e) {
    console.error('refresh error:', e);
  }
}

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

async function switchMode(mode) {
  try {
    await api('/api/engine/mode', { method: 'POST', body: JSON.stringify({ mode }) });
    toast(`Switched to ${mode} mode`);
    refresh();
  } catch (e) { toast(e.message, 'error'); }
}

async function restartEngine() {
  try {
    await api('/api/engine/restart', { method: 'POST' });
    toast('Engine restarting...');
    setTimeout(refresh, 1000);
  } catch (e) { toast(e.message, 'error'); }
}

function showAddModal() { document.getElementById('addModal').classList.add('show'); }
function showBatchModal() { document.getElementById('batchModal').classList.add('show'); }

async function showSettingsModal() {
  try {
    const s = await api('/api/settings');
    document.getElementById('setUrl').value = s.urltest_url;
    document.getElementById('setInterval').value = s.urltest_interval;
    document.getElementById('setTolerance').value = s.urltest_tolerance;
    document.getElementById('setRandomInterval').value = s.random_interval;
    document.getElementById('setClashPort').value = s.clash_api_port;
    document.getElementById('setClashSecret').value = s.clash_api_secret;
    document.getElementById('settingsModal').classList.add('show');
  } catch (e) { toast(e.message, 'error'); }
}

async function createAccount() {
  try {
    const body = {
      name: document.getElementById('addName').value,
      endpoint: document.getElementById('addEndpoint').value,
      endpoint_port: parseInt(document.getElementById('addPort').value) || 2408,
    };
    await api('/api/accounts', { method: 'POST', body: JSON.stringify(body) });
    toast('Account registered');
    closeModals();
    setTimeout(refresh, 1500);
  } catch (e) { toast(e.message, 'error'); }
}

async function batchCreate() {
  try {
    const body = {
      count: parseInt(document.getElementById('batchCount').value),
      endpoint: document.getElementById('batchEndpoint').value,
      endpoint_port: parseInt(document.getElementById('batchPort').value) || 2408,
    };
    toast('Batch registration started...');
    closeModals();
    await api('/api/accounts/batch', { method: 'POST', body: JSON.stringify(body) });
    toast('Batch registration complete');
    setTimeout(refresh, 1500);
  } catch (e) { toast(e.message, 'error'); }
}

async function deleteAccount(id, name) {
  if (!confirm(`Delete account "${name}"?`)) return;
  try {
    await api(`/api/accounts/${id}`, { method: 'DELETE' });
    toast('Account deleted');
    setTimeout(refresh, 1500);
  } catch (e) { toast(e.message, 'error'); }
}

async function toggleAccount(id, enabled) {
  try {
    await api(`/api/accounts/${id}`, { method: 'PATCH', body: JSON.stringify({ enabled }) });
    toast(enabled ? 'Account enabled' : 'Account disabled');
    setTimeout(refresh, 1500);
  } catch (e) { toast(e.message, 'error'); }
}

function editEndpoint(id, ep, port) {
  document.getElementById('editId').value = id;
  document.getElementById('editEndpoint').value = ep;
  document.getElementById('editPort').value = port;
  document.getElementById('editEndpointModal').classList.add('show');
}

async function saveEndpoint() {
  try {
    const id = document.getElementById('editId').value;
    const body = {
      endpoint: document.getElementById('editEndpoint').value,
      endpoint_port: parseInt(document.getElementById('editPort').value),
    };
    await api(`/api/accounts/${id}`, { method: 'PATCH', body: JSON.stringify(body) });
    toast('Endpoint updated');
    closeModals();
    setTimeout(refresh, 1500);
  } catch (e) { toast(e.message, 'error'); }
}

async function saveSettings() {
  try {
    const body = {
      rotation_mode: document.getElementById('btnRandom').classList.contains('active') ? 'random' : 'urltest',
      urltest_url: document.getElementById('setUrl').value,
      urltest_interval: parseInt(document.getElementById('setInterval').value),
      urltest_tolerance: parseInt(document.getElementById('setTolerance').value),
      random_interval: parseInt(document.getElementById('setRandomInterval').value),
      clash_api_port: parseInt(document.getElementById('setClashPort').value),
      clash_api_secret: document.getElementById('setClashSecret').value,
    };
    await api('/api/settings', { method: 'PUT', body: JSON.stringify(body) });
    toast('Settings saved');
    closeModals();
    setTimeout(refresh, 1500);
  } catch (e) { toast(e.message, 'error'); }
}

refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>
